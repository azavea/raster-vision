from rastervision.core.command import Command


class Train(Command):
    def __init__(self, ml_task, options):
        import io
        import base64

        data = u"""IyBDb3B5cmlnaHQgMjAxOCBUaGUgVGVuc29yRmxvdyBBdXRob3JzIEFsbCBSaWdodHMgUmVzZXJ2
ZWQuCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0
aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21w
bGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBM
aWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0Ut
Mi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGlu
IHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlz
dHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09O
RElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhl
IExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMg
YW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMgPT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09CgoiIiJQcm92aWRlcyBkYXRhIGZyb20gc2VtYW50aWMgc2VnbWVudGF0aW9uIGRhdGFzZXRz
LgoKVGhlIFNlZ21lbnRhdGlvbkRhdGFzZXQgY2xhc3MgcHJvdmlkZXMgYm90aCBpbWFnZXMgYW5k
IGFubm90YXRpb25zIChzZW1hbnRpYwpzZWdtZW50YXRpb24gYW5kL29yIGluc3RhbmNlIHNlZ21l
bnRhdGlvbikgZm9yIFRlbnNvckZsb3cuIEN1cnJlbnRseSwgd2UKc3VwcG9ydCB0aGUgZm9sbG93
aW5nIGRhdGFzZXRzOgoKMS4gUEFTQ0FMIFZPQyAyMDEyIChodHRwOi8vaG9zdC5yb2JvdHMub3gu
YWMudWsvcGFzY2FsL1ZPQy92b2MyMDEyLykuCgpQQVNDQUwgVk9DIDIwMTIgc2VtYW50aWMgc2Vn
bWVudGF0aW9uIGRhdGFzZXQgYW5ub3RhdGVzIDIwIGZvcmVncm91bmQgb2JqZWN0cwooZS5nLiwg
YmlrZSwgcGVyc29uLCBhbmQgc28gb24pIGFuZCBsZWF2ZXMgYWxsIHRoZSBvdGhlciBzZW1hbnRp
YyBjbGFzc2VzIGFzCm9uZSBiYWNrZ3JvdW5kIGNsYXNzLiBUaGUgZGF0YXNldCBjb250YWlucyAx
NDY0LCAxNDQ5LCBhbmQgMTQ1NiBhbm5vdGF0ZWQKaW1hZ2VzIGZvciB0aGUgdHJhaW5pbmcsIHZh
bGlkYXRpb24gYW5kIHRlc3QgcmVzcGVjdGl2ZWx5LgoKMi4gQ2l0eXNjYXBlcyBkYXRhc2V0ICho
dHRwczovL3d3dy5jaXR5c2NhcGVzLWRhdGFzZXQuY29tKQoKVGhlIENpdHlzY2FwZXMgZGF0YXNl
dCBjb250YWlucyAxOSBzZW1hbnRpYyBsYWJlbHMgKHN1Y2ggYXMgcm9hZCwgcGVyc29uLCBjYXIs
CmFuZCBzbyBvbikgZm9yIHVyYmFuIHN0cmVldCBzY2VuZXMuCgozLiBBREUyMEsgZGF0YXNldCAo
aHR0cDovL2dyb3Vwcy5jc2FpbC5taXQuZWR1L3Zpc2lvbi9kYXRhc2V0cy9BREUyMEspCgpUaGUg
QURFMjBLIGRhdGFzZXQgY29udGFpbnMgMTUwIHNlbWFudGljIGxhYmVscyBib3RoIHVyYmFuIHN0
cmVldCBzY2VuZXMgYW5kCmluZG9vciBzY2VuZXMuCgpSZWZlcmVuY2VzOgogIE0uIEV2ZXJpbmdo
YW0sIFMuIE0uIEEuIEVzbGFtaSwgTC4gVi4gR29vbCwgQy4gSy4gSS4gV2lsbGlhbXMsIEouIFdp
bm4sCiAgYW5kIEEuIFppc3Nlcm1hbiwgVGhlIHBhc2NhbCB2aXN1YWwgb2JqZWN0IGNsYXNzZXMg
Y2hhbGxlbmdlIGEgcmV0cm9zcGVjdGl2ZS4KICBJSkNWLCAyMDE0LgoKICBNLiBDb3JkdHMsIE0u
IE9tcmFuLCBTLiBSYW1vcywgVC4gUmVoZmVsZCwgTS4gRW56d2VpbGVyLCBSLiBCZW5lbnNvbiwK
ICBVLiBGcmFua2UsIFMuIFJvdGgsIGFuZCBCLiBTY2hpZWxlLCAiVGhlIGNpdHlzY2FwZXMgZGF0
YXNldCBmb3Igc2VtYW50aWMgdXJiYW4KICBzY2VuZSB1bmRlcnN0YW5kaW5nLCIgSW4gUHJvYy4g
b2YgQ1ZQUiwgMjAxNi4KCiAgQi4gWmhvdSwgSC4gWmhhbywgWC4gUHVpZywgUy4gRmlkbGVyLCBB
LiBCYXJyaXVzbywgQS4gVG9ycmFsYmEsICJTY2VuZSBQYXJzaW5nCiAgdGhyb3VnaCBBREUyMEsg
ZGF0YXNldCIsIEluIFByb2MuIG9mIENWUFIsIDIwMTcuCiIiIgppbXBvcnQgY29sbGVjdGlvbnMK
aW1wb3J0IG9zCmltcG9ydCBvcy5wYXRoCmltcG9ydCB0ZW5zb3JmbG93IGFzIHRmCgpzbGltID0g
dGYuY29udHJpYi5zbGltCgpkYXRhc2V0ID0gc2xpbS5kYXRhc2V0Cgp0ZmV4YW1wbGVfZGVjb2Rl
ciA9IHNsaW0udGZleGFtcGxlX2RlY29kZXIKCgpfSVRFTVNfVE9fREVTQ1JJUFRJT05TID0gewog
ICAgJ2ltYWdlJzogJ0EgY29sb3IgaW1hZ2Ugb2YgdmFyeWluZyBoZWlnaHQgYW5kIHdpZHRoLics
CiAgICAnbGFiZWxzX2NsYXNzJzogKCdBIHNlbWFudGljIHNlZ21lbnRhdGlvbiBsYWJlbCB3aG9z
ZSBzaXplIG1hdGNoZXMgaW1hZ2UuJwogICAgICAgICAgICAgICAgICAgICAnSXRzIHZhbHVlcyBy
YW5nZSBmcm9tIDAgKGJhY2tncm91bmQpIHRvIG51bV9jbGFzc2VzLicpLAp9CgojIE5hbWVkIHR1
cGxlIHRvIGRlc2NyaWJlIHRoZSBkYXRhc2V0IHByb3BlcnRpZXMuCkRhdGFzZXREZXNjcmlwdG9y
ID0gY29sbGVjdGlvbnMubmFtZWR0dXBsZSgKICAgICdEYXRhc2V0RGVzY3JpcHRvcicsCiAgICBb
J3NwbGl0c190b19zaXplcycsICAgIyBTcGxpdHMgb2YgdGhlIGRhdGFzZXQgaW50byB0cmFpbmlu
ZywgdmFsLCBhbmQgdGVzdC4KICAgICAnbnVtX2NsYXNzZXMnLCAgICMgTnVtYmVyIG9mIHNlbWFu
dGljIGNsYXNzZXMsIGluY2x1ZGluZyB0aGUgYmFja2dyb3VuZAogICAgICAgICAgICAgICAgICAg
ICAgIyBjbGFzcyAoaWYgZXhpc3RzKS4gRm9yIGV4YW1wbGUsIHRoZXJlIGFyZSAyMAogICAgICAg
ICAgICAgICAgICAgICAgIyBmb3JlZ3JvdW5kIGNsYXNzZXMgKyAxIGJhY2tncm91bmQgY2xhc3Mg
aW4gdGhlIFBBU0NBTAogICAgICAgICAgICAgICAgICAgICAgIyBWT0MgMjAxMiBkYXRhc2V0LiBU
aHVzLCB3ZSBzZXQgbnVtX2NsYXNzZXM9MjEuCiAgICAgJ2lnbm9yZV9sYWJlbCcsICAjIElnbm9y
ZSBsYWJlbCB2YWx1ZS4KICAgIF0KKQoKX0NJVFlTQ0FQRVNfSU5GT1JNQVRJT04gPSBEYXRhc2V0
RGVzY3JpcHRvcigKICAgIHNwbGl0c190b19zaXplcz17CiAgICAgICAgJ3RyYWluJzogMjk3NSwK
ICAgICAgICAndmFsJzogNTAwLAogICAgfSwKICAgIG51bV9jbGFzc2VzPTE5LAogICAgaWdub3Jl
X2xhYmVsPTI1NSwKKQoKX1BBU0NBTF9WT0NfU0VHX0lORk9STUFUSU9OID0gRGF0YXNldERlc2Ny
aXB0b3IoCiAgICBzcGxpdHNfdG9fc2l6ZXM9ewogICAgICAgICd0cmFpbic6IDE0NjQsCiAgICAg
ICAgJ3RyYWludmFsJzogMjkxMywKICAgICAgICAndmFsJzogMTQ0OSwKICAgIH0sCiAgICBudW1f
Y2xhc3Nlcz0yMSwKICAgIGlnbm9yZV9sYWJlbD0yNTUsCikKCiMgVGhlc2UgbnVtYmVyIChpLmUu
LCAndHJhaW4nLyd0ZXN0Jykgc2VlbXMgdG8gaGF2ZSB0byBiZSBoYXJkIGNvZGVkCiMgWW91IGFy
ZSByZXF1aXJlZCB0byBmaWd1cmUgaXQgb3V0IGZvciB5b3VyIHRyYWluaW5nL3Rlc3RpbmcgZXhh
bXBsZS4KX0FERTIwS19JTkZPUk1BVElPTiA9IERhdGFzZXREZXNjcmlwdG9yKAogICAgc3BsaXRz
X3RvX3NpemVzPXsKICAgICAgICAndHJhaW4nOiAyMDIxMCwgICMgbnVtIG9mIHNhbXBsZXMgaW4g
aW1hZ2VzL3RyYWluaW5nCiAgICAgICAgJ3ZhbCc6IDIwMDAsICAjIG51bSBvZiBzYW1wbGVzIGlu
IGltYWdlcy92YWxpZGF0aW9uCiAgICB9LAogICAgbnVtX2NsYXNzZXM9MTUxLAogICAgaWdub3Jl
X2xhYmVsPTAsCikKCl9DVVNUT01fSU5GT1JNQVRJT04gPSBEYXRhc2V0RGVzY3JpcHRvcigKICAg
IHNwbGl0c190b19zaXplcz17CiAgICAgICAgJ3RyYWluJzogaW50KG9zLmVudmlyb24uZ2V0KCdE
TF9DVVNUT01fVFJBSU4nKSBvciAxMDAwKSwKICAgICAgICAndmFsaWRhdGlvbic6IGludChvcy5l
bnZpcm9uLmdldCgnRExfQ1VTVE9NX1ZBTElEQVRJT04nKSBvciAxMDAwKSwKICAgIH0sCiAgICBu
dW1fY2xhc3Nlcz1pbnQob3MuZW52aXJvbi5nZXQoJ0RMX0NVU1RPTV9DTEFTU0VTJykgb3IgMTAp
LAogICAgaWdub3JlX2xhYmVsPWludChvcy5lbnZpcm9uLmdldCgnRExfQ1VTVE9NX0lHTk9SRScp
IG9yIDApLAopCgoKX0RBVEFTRVRTX0lORk9STUFUSU9OID0gewogICAgJ2NpdHlzY2FwZXMnOiBf
Q0lUWVNDQVBFU19JTkZPUk1BVElPTiwKICAgICdwYXNjYWxfdm9jX3NlZyc6IF9QQVNDQUxfVk9D
X1NFR19JTkZPUk1BVElPTiwKICAgICdhZGUyMGsnOiBfQURFMjBLX0lORk9STUFUSU9OLAogICAg
J2N1c3RvbSc6IF9DVVNUT01fSU5GT1JNQVRJT04sCn0KCiMgRGVmYXVsdCBmaWxlIHBhdHRlcm4g
b2YgVEZSZWNvcmQgb2YgVGVuc29yRmxvdyBFeGFtcGxlLgpfRklMRV9QQVRURVJOID0gJyVzLSon
CgoKZGVmIGdldF9jaXR5c2NhcGVzX2RhdGFzZXRfbmFtZSgpOgogIHJldHVybiAnY2l0eXNjYXBl
cycKCgpkZWYgZ2V0X2RhdGFzZXQoZGF0YXNldF9uYW1lLCBzcGxpdF9uYW1lLCBkYXRhc2V0X2Rp
cik6CiAgIiIiR2V0cyBhbiBpbnN0YW5jZSBvZiBzbGltIERhdGFzZXQuCgogIEFyZ3M6CiAgICBk
YXRhc2V0X25hbWU6IERhdGFzZXQgbmFtZS4KICAgIHNwbGl0X25hbWU6IEEgdHJhaW4vdmFsIFNw
bGl0IG5hbWUuCiAgICBkYXRhc2V0X2RpcjogVGhlIGRpcmVjdG9yeSBvZiB0aGUgZGF0YXNldCBz
b3VyY2VzLgoKICBSZXR1cm5zOgogICAgQW4gaW5zdGFuY2Ugb2Ygc2xpbSBEYXRhc2V0LgoKICBS
YWlzZXM6CiAgICBWYWx1ZUVycm9yOiBpZiB0aGUgZGF0YXNldF9uYW1lIG9yIHNwbGl0X25hbWUg
aXMgbm90IHJlY29nbml6ZWQuCiAgIiIiCiAgaWYgZGF0YXNldF9uYW1lIG5vdCBpbiBfREFUQVNF
VFNfSU5GT1JNQVRJT046CiAgICByYWlzZSBWYWx1ZUVycm9yKCdUaGUgc3BlY2lmaWVkIGRhdGFz
ZXQgaXMgbm90IHN1cHBvcnRlZCB5ZXQuJykKCiAgc3BsaXRzX3RvX3NpemVzID0gX0RBVEFTRVRT
X0lORk9STUFUSU9OW2RhdGFzZXRfbmFtZV0uc3BsaXRzX3RvX3NpemVzCgogIGlmIHNwbGl0X25h
bWUgbm90IGluIHNwbGl0c190b19zaXplczoKICAgIHJhaXNlIFZhbHVlRXJyb3IoJ2RhdGEgc3Bs
aXQgbmFtZSAlcyBub3QgcmVjb2duaXplZCcgJSBzcGxpdF9uYW1lKQoKICAjIFByZXBhcmUgdGhl
IHZhcmlhYmxlcyBmb3IgZGlmZmVyZW50IGRhdGFzZXRzLgogIG51bV9jbGFzc2VzID0gX0RBVEFT
RVRTX0lORk9STUFUSU9OW2RhdGFzZXRfbmFtZV0ubnVtX2NsYXNzZXMKICBpZ25vcmVfbGFiZWwg
PSBfREFUQVNFVFNfSU5GT1JNQVRJT05bZGF0YXNldF9uYW1lXS5pZ25vcmVfbGFiZWwKCiAgZmls
ZV9wYXR0ZXJuID0gX0ZJTEVfUEFUVEVSTgogIGZpbGVfcGF0dGVybiA9IG9zLnBhdGguam9pbihk
YXRhc2V0X2RpciwgZmlsZV9wYXR0ZXJuICUgc3BsaXRfbmFtZSkKCiAgIyBTcGVjaWZ5IGhvdyB0
aGUgVEYtRXhhbXBsZXMgYXJlIGRlY29kZWQuCiAga2V5c190b19mZWF0dXJlcyA9IHsKICAgICAg
J2ltYWdlL2VuY29kZWQnOiB0Zi5GaXhlZExlbkZlYXR1cmUoCiAgICAgICAgICAoKSwgdGYuc3Ry
aW5nLCBkZWZhdWx0X3ZhbHVlPScnKSwKICAgICAgJ2ltYWdlL2ZpbGVuYW1lJzogdGYuRml4ZWRM
ZW5GZWF0dXJlKAogICAgICAgICAgKCksIHRmLnN0cmluZywgZGVmYXVsdF92YWx1ZT0nJyksCiAg
ICAgICdpbWFnZS9mb3JtYXQnOiB0Zi5GaXhlZExlbkZlYXR1cmUoCiAgICAgICAgICAoKSwgdGYu
c3RyaW5nLCBkZWZhdWx0X3ZhbHVlPSdqcGVnJyksCiAgICAgICdpbWFnZS9oZWlnaHQnOiB0Zi5G
aXhlZExlbkZlYXR1cmUoCiAgICAgICAgICAoKSwgdGYuaW50NjQsIGRlZmF1bHRfdmFsdWU9MCks
CiAgICAgICdpbWFnZS93aWR0aCc6IHRmLkZpeGVkTGVuRmVhdHVyZSgKICAgICAgICAgICgpLCB0
Zi5pbnQ2NCwgZGVmYXVsdF92YWx1ZT0wKSwKICAgICAgJ2ltYWdlL3NlZ21lbnRhdGlvbi9jbGFz
cy9lbmNvZGVkJzogdGYuRml4ZWRMZW5GZWF0dXJlKAogICAgICAgICAgKCksIHRmLnN0cmluZywg
ZGVmYXVsdF92YWx1ZT0nJyksCiAgICAgICdpbWFnZS9zZWdtZW50YXRpb24vY2xhc3MvZm9ybWF0
JzogdGYuRml4ZWRMZW5GZWF0dXJlKAogICAgICAgICAgKCksIHRmLnN0cmluZywgZGVmYXVsdF92
YWx1ZT0ncG5nJyksCiAgfQogIGl0ZW1zX3RvX2hhbmRsZXJzID0gewogICAgICAnaW1hZ2UnOiB0
ZmV4YW1wbGVfZGVjb2Rlci5JbWFnZSgKICAgICAgICAgIGltYWdlX2tleT0naW1hZ2UvZW5jb2Rl
ZCcsCiAgICAgICAgICBmb3JtYXRfa2V5PSdpbWFnZS9mb3JtYXQnLAogICAgICAgICAgY2hhbm5l
bHM9MyksCiAgICAgICdpbWFnZV9uYW1lJzogdGZleGFtcGxlX2RlY29kZXIuVGVuc29yKCdpbWFn
ZS9maWxlbmFtZScpLAogICAgICAnaGVpZ2h0JzogdGZleGFtcGxlX2RlY29kZXIuVGVuc29yKCdp
bWFnZS9oZWlnaHQnKSwKICAgICAgJ3dpZHRoJzogdGZleGFtcGxlX2RlY29kZXIuVGVuc29yKCdp
bWFnZS93aWR0aCcpLAogICAgICAnbGFiZWxzX2NsYXNzJzogdGZleGFtcGxlX2RlY29kZXIuSW1h
Z2UoCiAgICAgICAgICBpbWFnZV9rZXk9J2ltYWdlL3NlZ21lbnRhdGlvbi9jbGFzcy9lbmNvZGVk
JywKICAgICAgICAgIGZvcm1hdF9rZXk9J2ltYWdlL3NlZ21lbnRhdGlvbi9jbGFzcy9mb3JtYXQn
LAogICAgICAgICAgY2hhbm5lbHM9MSksCiAgfQoKICBkZWNvZGVyID0gdGZleGFtcGxlX2RlY29k
ZXIuVEZFeGFtcGxlRGVjb2RlcigKICAgICAga2V5c190b19mZWF0dXJlcywgaXRlbXNfdG9faGFu
ZGxlcnMpCgogIHJldHVybiBkYXRhc2V0LkRhdGFzZXQoCiAgICAgIGRhdGFfc291cmNlcz1maWxl
X3BhdHRlcm4sCiAgICAgIHJlYWRlcj10Zi5URlJlY29yZFJlYWRlciwKICAgICAgZGVjb2Rlcj1k
ZWNvZGVyLAogICAgICBudW1fc2FtcGxlcz1zcGxpdHNfdG9fc2l6ZXNbc3BsaXRfbmFtZV0sCiAg
ICAgIGl0ZW1zX3RvX2Rlc2NyaXB0aW9ucz1fSVRFTVNfVE9fREVTQ1JJUFRJT05TLAogICAgICBp
Z25vcmVfbGFiZWw9aWdub3JlX2xhYmVsLAogICAgICBudW1fY2xhc3Nlcz1udW1fY2xhc3NlcywK
ICAgICAgbmFtZT1kYXRhc2V0X25hbWUsCiAgICAgIG11bHRpX2xhYmVsPVRydWUpCg==
"""
        with io.StringIO(data) as fin:
            with open('/opt/tf-models/deeplab/datasets/segmentation_dataset.py', 'wb') as fout:
                base64.decode(fin, fout)

        self.ml_task = ml_task
        self.options = options

    def run(self):
        self.ml_task.train(self.options)
