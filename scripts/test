#!/bin/bash

set -e

if [[ -n ${RASTER_VISION_DEBUG} ]]; then
    set -x
fi

function usage() {
    echo -n \
        "Usage: $(basename "$0")
Run linters and tests.
"
}

if [[ ${BASH_SOURCE[0]} == "${0}" ]]; then
    if [[ ${1:-} == "--help" ]]; then
        usage
    else
        if [[ -z ${CI} ]]; then
            # Local test suite runs against pytorch image by default
            IMAGE_TYPE=${IMAGE_TYPE:-pytorch}
        fi

        # Delete old coverage reports
        docker run \
            -w "$(pwd)" \
            -v "$(pwd):$(pwd)" \
            --rm -t \
            "raster-vision-${IMAGE_TYPE}" \
            rm -f "$(pwd)/.coverage" "$(pwd)/coverage.xml"

        # Execute test suites
        docker run \
            --rm -t \
            "raster-vision-${IMAGE_TYPE}" \
            /opt/src/scripts/style_tests
        docker run \
            -w "$(pwd)" \
            -v "$(pwd):$(pwd)" \
            --rm -t \
            "raster-vision-${IMAGE_TYPE}" \
            /opt/src/scripts/unit_tests
        docker run \
            --rm -t \
            "raster-vision-${IMAGE_TYPE}" \
            /opt/src/scripts/integration_tests

        # Create new coverage reports
        docker run \
            -w "$(pwd)" \
            -v "$(pwd):$(pwd)" \
            --rm -t \
            "raster-vision-${IMAGE_TYPE}" \
            coverage xml
    fi
fi
